# Empire v7.3 - Service Configuration Manifest
# Service Orchestration Architecture
#
# This file defines all 23 services and their health check configurations.
# Used by ServiceOrchestrator for startup validation and health monitoring.

version: "1.0"
app_name: "Empire"
app_version: "7.3.0"

# =============================================================================
# REQUIRED SERVICES
# App won't function without these - startup will fail if unhealthy
# =============================================================================
required:
  - name: supabase
    type: database
    description: "PostgreSQL with pgvector for document storage and vector search"
    health_check:
      type: query
      query: "SELECT 1"
    timeout_ms: 2000
    env_vars:
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
    fallback: null  # No fallback - required

  - name: redis
    type: cache
    description: "Redis for caching, Celery broker, and rate limiting"
    health_check:
      type: ping
      command: "PING"
    timeout_ms: 2000
    env_vars:
      - REDIS_URL
    fallback: null  # No fallback - required

# =============================================================================
# IMPORTANT SERVICES
# Major features depend on these - app can start but will be degraded
# =============================================================================
important:
  - name: neo4j
    type: graph
    description: "Neo4j knowledge graph for entity relationships"
    health_check:
      type: driver
      method: "verify_connectivity"
    timeout_ms: 1000
    env_vars:
      - NEO4J_URI
      - NEO4J_USERNAME
      - NEO4J_PASSWORD
    startup_command: "docker-compose up neo4j -d"
    fallback: "Knowledge graph features disabled"

  - name: b2
    type: storage
    description: "Backblaze B2 for file storage and reports"
    health_check:
      type: api
      method: "check_connection"
    timeout_ms: 1000
    env_vars:
      - B2_APPLICATION_KEY_ID
      - B2_APPLICATION_KEY
      - B2_BUCKET_NAME
    fallback: "File upload disabled"

  - name: celery
    type: queue
    description: "Celery workers for background task processing"
    health_check:
      type: celery
      method: "control.ping"
    timeout_ms: 2000
    startup_command: "celery -A app.celery_app worker --loglevel=info"
    fallback: "Processing requests synchronously"

  - name: anthropic
    type: api
    description: "Anthropic Claude API for LLM features"
    health_check:
      type: env_check
      # Check via circuit breaker status
    timeout_ms: 1000
    env_vars:
      - ANTHROPIC_API_KEY
    fallback: "LLM features unavailable"

  - name: llamaindex
    type: service
    description: "LlamaIndex service for document parsing and indexing"
    health_check:
      type: http
      url: "https://jb-llamaindex.onrender.com/health"
      expected_status: 200
    timeout_ms: 5000
    fallback: "Document parsing disabled"

  - name: crewai
    type: service
    description: "CrewAI service for multi-agent AI orchestration"
    health_check:
      type: http
      url: "https://jb-crewai.onrender.com/api/crewai/health"
      expected_status: 200
    timeout_ms: 5000
    fallback: "Multi-agent features disabled"

# =============================================================================
# OPTIONAL SERVICES
# Graceful degradation available - features disabled when unavailable
# =============================================================================
optional:
  - name: arcade
    type: api
    description: "Arcade.dev for external tool integrations"
    health_check:
      type: env_check
    timeout_ms: 500
    env_vars:
      - ARCADE_API_KEY
    fallback: "External tools unavailable"

  - name: soniox
    type: api
    description: "Soniox for audio transcription"
    health_check:
      type: env_check
    timeout_ms: 500
    env_vars:
      - SONIOX_API_KEY
    fallback: "Audio processing disabled"

  - name: claude_vision
    type: api
    description: "Claude Vision for image analysis"
    health_check:
      type: feature_flag
      flag: "vision_enabled"
    timeout_ms: 500
    fallback: "Vision analysis disabled"

  - name: ffmpeg
    type: local
    description: "FFmpeg for video/audio processing"
    health_check:
      type: executable
      command: "ffmpeg -version"
    timeout_ms: 500
    fallback: "Video processing unavailable"

  - name: openai
    type: api
    description: "OpenAI API as fallback LLM"
    health_check:
      type: env_check
    timeout_ms: 500
    env_vars:
      - OPENAI_API_KEY
    fallback: "Fallback LLM unavailable"

  - name: llamacloud
    type: api
    description: "LlamaCloud for advanced document parsing"
    health_check:
      type: env_check
    timeout_ms: 500
    env_vars:
      - LLAMA_CLOUD_API_KEY
    fallback: "Advanced parsing disabled"

  - name: ollama
    type: local
    description: "Ollama for local model inference (BGE-M3 embeddings)"
    health_check:
      type: http
      url: "http://localhost:11434/api/tags"
      expected_status: 200
    timeout_ms: 1000
    fallback: "Using cloud embeddings"

# =============================================================================
# INFRASTRUCTURE SERVICES
# Monitoring and observability stack - app functions normally without
# =============================================================================
infrastructure:
  - name: prometheus
    type: monitoring
    description: "Prometheus metrics collection and storage"
    health_check:
      type: http
      url: "http://localhost:9090/-/healthy"
      expected_status: 200
    port: 9090
    timeout_ms: 500
    fallback: "Metrics collection disabled"

  - name: grafana
    type: monitoring
    description: "Grafana dashboards for visualization"
    health_check:
      type: http
      url: "http://localhost:3001/api/health"
      expected_status: 200
    port: 3001
    timeout_ms: 500
    fallback: "Dashboards unavailable"

  - name: alertmanager
    type: monitoring
    description: "Alertmanager for alert routing and notifications"
    health_check:
      type: http
      url: "http://localhost:9093/-/healthy"
      expected_status: 200
    port: 9093
    timeout_ms: 500
    fallback: "Alerting disabled"

  - name: node_exporter
    type: monitoring
    description: "Node exporter for system-level metrics"
    health_check:
      type: prometheus_scrape
    port: 9100
    timeout_ms: 500
    fallback: "System metrics unavailable"

  - name: flower
    type: monitoring
    description: "Flower for Celery task monitoring"
    health_check:
      type: http
      url: "http://localhost:5555/"
      expected_status: 200
    port: 5555
    timeout_ms: 500
    fallback: "Celery monitoring unavailable"

# =============================================================================
# AUTHENTICATION & EMAIL (Feature-flagged)
# =============================================================================
authentication:
  - name: clerk
    type: auth
    description: "Clerk authentication (optional)"
    health_check:
      type: feature_flag
      flag: "clerk_enabled"
    timeout_ms: 500
    env_vars:
      - CLERK_SECRET_KEY
    fallback: "Using default authentication"

  - name: sendgrid
    type: email
    description: "SendGrid for transactional emails"
    health_check:
      type: feature_flag
      flag: "sendgrid_enabled"
    timeout_ms: 500
    env_vars:
      - SENDGRID_API_KEY
    fallback: "Email notifications disabled"

  - name: gmail_smtp
    type: email
    description: "Gmail SMTP for email notifications"
    health_check:
      type: feature_flag
      flag: "gmail_enabled"
    timeout_ms: 500
    env_vars:
      - GMAIL_APP_PASSWORD
    fallback: "Email notifications disabled"

# =============================================================================
# GRACEFUL DEGRADATION MATRIX
# =============================================================================
degradation_matrix:
  supabase:
    impact: "CRITICAL"
    user_message: "Service temporarily unavailable. Please try again later."
    affected_endpoints: ["*"]

  redis:
    impact: "CRITICAL"
    user_message: "Service temporarily unavailable. Please try again later."
    affected_endpoints: ["*"]

  neo4j:
    impact: "Graph features disabled"
    user_message: "Knowledge graph features are temporarily unavailable."
    affected_endpoints:
      - "/api/graph/*"
      - "/api/knowledge-graph/*"

  b2:
    impact: "File upload disabled"
    user_message: "File uploads are temporarily unavailable."
    affected_endpoints:
      - "/api/v1/upload/*"
      - "/api/documents/upload"

  celery:
    impact: "Sync processing only"
    user_message: "Processing may be slower than usual."
    affected_endpoints:
      - "Background task endpoints"

  anthropic:
    impact: "LLM features disabled"
    user_message: "AI features are temporarily unavailable."
    affected_endpoints:
      - "/api/query/*"
      - "/api/chat/*"

  llamaindex:
    impact: "Document parsing disabled"
    user_message: "Document parsing is temporarily unavailable."
    affected_endpoints:
      - "/api/llama-index/*"

  crewai:
    impact: "Multi-agent disabled"
    user_message: "Advanced AI workflows are temporarily unavailable."
    affected_endpoints:
      - "/api/crewai/*"
      - "/api/orchestration/*"

# =============================================================================
# TIMEOUT CONFIGURATION
# =============================================================================
timeouts:
  required: 2000      # Required services get longer timeout
  important: 1000     # Important services need quick check
  optional: 500       # Optional services - skip if slow
  infrastructure: 500 # Nice to have, not critical

# =============================================================================
# STARTUP CONFIGURATION
# =============================================================================
startup:
  # Target: App ready in < 3 seconds
  max_startup_time_ms: 3000

  # Two-phase startup
  phase1_blocking: true   # Required services block startup
  phase2_background: true # Important/optional check in background

  # Health check caching
  cache_ttl_seconds: 30

  # Retry configuration
  retry_count: 3
  retry_delay_ms: 1000

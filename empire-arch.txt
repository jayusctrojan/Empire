Empire v7.5 Complete Architecture
Multi-Model AI Pipeline + Cloud Hybrid Architecture

Core Infrastructure

Cloud Services (Render.com)
  - jb-empire-api: FastAPI backend, 57 route modules, 300+ endpoints ($7/month)
  - empire-celery-worker: Background task processing ($7/month)
  - jb-empire-chat: Gradio web chat interface ($7/month)
  - jb-crewai: Multi-agent orchestration ($7/month)

Mac Studio (Local)
  - Neo4j: Knowledge graph database (Docker)
  - Ollama: Qwen2.5-VL-32B for local vision (zero cost)
  - faster-whisper: distil-whisper/distil-large-v3.5 for audio STT (zero cost)
  - BGE-M3: Embedding generation (1024-dim vectors)
  - BGE-Reranker-v2: Search result reranking

Cloud Databases
  - Supabase: PostgreSQL + pgvector ($25/month)
  - Upstash: Redis caching + Celery broker (Free tier)
  - Backblaze B2: File + artifact storage (~$5/month)

AI Model Architecture

Multi-Model Quality Pipeline (every query):
  User Query
    |
    v
  [STAGE 1: PROMPT ENGINEER - Claude Sonnet 4.5 (Anthropic)]
    - Intent detection (factual/analytical/creative/document)
    - Output format detection (text/table/report/spreadsheet)
    - Enriched, structured query with instructions
    - Cost: ~$0.002/query
    |
    v
  [Query Expansion - Kimi K2.5 (Together AI)] -> RAG Search -> BGE-Reranker-v2
    |
    v
  [STAGE 2: REASONING ENGINE - Kimi K2.5 Thinking (Together AI)]
    - Deep reasoning with think tokens
    - Citations [1], [2] from retrieved sources
    - Raw response (NOT streamed to user)
    - Configurable thinking tokens: Speed(1024) / Balanced(4096) / Quality(16384)
    |
    v
  [STAGE 3: OUTPUT ARCHITECT - Claude Sonnet 4.5 (Anthropic)]
    - Formats and structures the response
    - Detects if artifact is needed (DOCX/XLSX/PPTX/PDF)
    - Streams formatted output to user
    - Cost: ~$0.002/query
    |
    v (if artifact detected)
  [Document Generator] -> [Backblaze B2 Storage] -> [Artifact card in chat]

Streaming UX Phases:
  1. "Analyzing..." (Prompt Engineer)
  2. "Searching..." (Query expansion + RAG)
  3. "Thinking..." (Kimi K2.5 reasoning)
  4. "Formatting..." (Output Architect)
  5. Token-by-token streaming of formatted response

Graceful Degradation:
  If either Sonnet call fails -> fallback to raw query -> Kimi -> raw response

All AI Models Used:
  Purpose              | Model                      | Provider       | Type
  Prompt Engineering   | Claude Sonnet 4.5          | Anthropic      | Cloud API
  Output Formatting    | Claude Sonnet 4.5          | Anthropic      | Cloud API
  Reasoning Engine     | Kimi K2.5 Thinking         | Together AI    | Cloud API
  Query Expansion      | Kimi K2.5                  | Together AI    | Cloud API
  Image Analysis       | Kimi K2.5 Thinking         | Together AI    | Cloud API (primary)
  Image Fallback       | Gemini 3 Flash             | Google AI      | Cloud API
  Local Vision         | Qwen2.5-VL-32B            | Ollama         | Local (Mac Studio)
  Audio STT            | distil-whisper-large-v3.5  | faster-whisper | Local (Mac Studio)
  Video Frames         | Gemini 3 Flash             | Google AI      | Cloud API
  Embeddings           | BGE-M3                     | Local/Render   | 1024-dim vectors
  Reranking            | BGE-Reranker-v2            | Local          | Search optimization

LLM Client Abstraction Layer (app/services/llm_client.py):
  LLMClient (abstract base)
    |-- TogetherAILLMClient    (Kimi K2.5 Thinking)
    |-- AnthropicLLMClient     (Claude Sonnet 4.5)
    |-- GeminiLLMClient        (Gemini 3 Flash)
    |-- OpenAICompatibleClient (Ollama/Qwen2.5-VL, any OpenAI-compatible API)

  Interface: generate(), generate_with_images(), is_retryable()

Database Architecture

Hybrid Database System:
  PostgreSQL (Supabase) - $25/month
    - Vector embeddings (pgvector, 1024-dim)
    - User accounts and authentication
    - Document content and metadata
    - Chat sessions and messages
    - Organizations and memberships
    - Generated artifacts
    - Audit logs
    - Row-Level Security on org-scoped tables

  Neo4j (Mac Studio Docker) - $0
    - Knowledge graphs
    - Entity relationships
    - Multi-hop graph traversal
    - Community detection
    - Centrality analysis

  Redis (Upstash) - Free
    - Caching
    - Celery message broker
    - Rate limiting

Key PostgreSQL Tables (v7.5):
  Core:
    - documents_v2: Document metadata and content
    - record_manager_v2: Vector embeddings
    - knowledge_entities: Extracted entities
    - chat_sessions: Legacy chat history
    - audit_logs: Security audit trail

  v7.5 Additions:
    - organizations: Company/org entities (slug, logo, settings)
    - org_memberships: User-org relationships (owner/admin/member/viewer)
    - studio_cko_sessions: CKO chat sessions (org-scoped)
    - studio_cko_messages: CKO chat messages
    - studio_cko_artifacts: Generated document artifacts
    - projects: Projects (org-scoped)

Storage Architecture

Backblaze B2 (b2://empire-documents/):
  {department}/           # 12 business departments
    {document_id}/
      original.pdf
      processed.txt
      metadata.json
  artifacts/documents/    # Generated artifacts (v7.5)
    {artifact_id}.docx
    {artifact_id}.xlsx
    {artifact_id}.pptx
  crewai/assets/          # CrewAI outputs

Application Architecture

Backend (FastAPI - Python 3.11+):
  app/
    routes/              # 57 API route modules (300+ endpoints)
      unified_search.py  # Cross-type search with asyncio.gather
      organizations.py   # Multi-tenant org management
      artifacts.py       # Artifact CRUD + download
      studio_cko.py      # CKO chat with multi-model pipeline
    services/            # 139 service files
      llm_client.py              # Unified LLM provider abstraction
      prompt_engineer_service.py  # Sonnet 4.5 prompt enrichment
      output_architect_service.py # Sonnet 4.5 output formatting
      document_generator_service.py # DOCX/XLSX/PPTX/PDF generation
      vision_service.py           # Multi-provider image analysis
      whisper_stt_service.py      # Local audio transcription
      audio_video_processor.py    # Video frame extraction
      studio_cko_conversation_service.py # CKO orchestration
      organization_service.py     # Org CRUD + membership
      cost_tracking_service.py    # Per-query cost tracking
    core/
      database.py        # Supabase client
      config.py          # Environment config
    middleware/           # Auth, rate limiting, org context

Desktop App (Tauri 2.x + React + TypeScript):
  empire-desktop/
    src/
      components/         # 31 React components
        auth/             # Authentication (Clerk)
        chat/             # Chat UI, artifacts, phase indicators
        projects/         # Project management
        GlobalSearch.tsx  # Cmd+K unified search
        OrgPicker.tsx     # Organization selection
        OrgSwitcher.tsx   # Org switching dropdown
      stores/             # Zustand state management
        chat.ts           # Conversations, messages, artifacts, phases
        app.ts            # View state, sidebar
        org.ts            # Organization selection
        projects.ts       # Project list
      lib/api/            # Backend API client (X-Org-Id header)

Organization Layer (Multi-Tenant):
  Organization (company)
    |-- org_memberships (user <-> org, roles: owner/admin/member/viewer)
    |-- projects (org-scoped)
    |-- studio_cko_sessions (chats, org-scoped)
    |-- documents (KB, org-scoped)
    |-- studio_cko_artifacts (org-scoped)
  Row-Level Security on all org-scoped tables

Security Architecture

  Transport: TLS 1.2+ on all services
  Authentication: Clerk auth + JWT tokens
  Authorization: Row-Level Security on org-scoped tables
  Multi-Tenancy: Organization-level data isolation
  API Auth: X-API-Key for Telegram bots and integrations
  Rate Limiting: Redis-backed, tiered by endpoint
  Encryption: AES-256 at rest (Supabase, B2)
  Audit: Comprehensive event logging
  Input Sanitization: PostgREST ilike injection protection
  HTTP Headers: HSTS, CSP, X-Frame-Options: DENY, X-Content-Type-Options: nosniff

Document Generation:
  Format | Library      | Generated From
  DOCX   | python-docx  | Headings, paragraphs, tables, code, lists
  XLSX   | openpyxl     | Table blocks, header formatting, auto-width
  PPTX   | python-pptx  | Title slide, heading slides, bullets, tables
  PDF    | PDFReportGenerator | Full formatted reports

Monitoring:
  Prometheus: Metrics collection (port 9090)
  Grafana: Visualization (port 3001)
  Alertmanager: Email notifications (port 9093)
  39 alert rules: Critical, Warning, Info

15+ AI Agents:
  AGENT-002: Content Summarizer
  AGENT-008: Department Classifier (12 departments)
  AGENT-009: Senior Research Analyst
  AGENT-010: Content Strategist
  AGENT-011: Fact Checker
  AGENT-012: Research Agent
  AGENT-013: Analysis Agent
  AGENT-014: Writing Agent
  AGENT-015: Review Agent
  Prompt Engineer (Sonnet 4.5)
  Output Architect (Sonnet 4.5)

Cost Summary:
  Render Services (4): $28/month
  Supabase PostgreSQL: $25/month
  Backblaze B2: ~$5/month
  Upstash Redis: Free
  Neo4j (self-hosted): $0
  Infrastructure Total: ~$60/month
  Anthropic API (Sonnet 4.5): ~$0.004/query
  Together AI (Kimi K2.5): Usage-based
  Google AI (Gemini 3 Flash): Usage-based

Testing:
  Backend: pytest (170+ test files)
  Frontend: vitest + @testing-library/react (22 tests)
  Code Review: CodeRabbit (automated on every PR)

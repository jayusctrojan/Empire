# Data Model: Research Projects

**Feature**: Research Projects (Agent Harness)
**Date**: 2025-01-10
**Database**: Supabase PostgreSQL

## Entity Relationship Diagram

```
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│  research_jobs  │───1:N─│   plan_tasks    │───1:N─│research_artifacts│
│                 │       │                 │       │                 │
│ id (PK)         │       │ id (PK)         │       │ id (PK)         │
│ user_id (FK)    │       │ job_id (FK)     │       │ job_id (FK)     │
│ query           │       │ task_key        │       │ task_id (FK)    │
│ status          │       │ task_type       │       │ artifact_type   │
│ progress_%      │       │ depends_on[]    │       │ content         │
└─────────────────┘       │ status          │       │ source          │
         │                └─────────────────┘       └─────────────────┘
         │
         │        ┌─────────────────┐
         └───1:N──│ shared_reports  │
                  │                 │
                  │ id (PK)         │
                  │ job_id (FK)     │
                  │ share_token     │
                  │ revoked_at      │
                  └─────────────────┘
```

---

## Table: research_jobs

**Purpose**: Stores research project metadata, status, and results

```sql
CREATE TABLE public.research_jobs (
    -- Primary Key
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

    -- Ownership
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    customer_id TEXT NOT NULL,

    -- Research Request
    query TEXT NOT NULL,
    context TEXT,
    research_type TEXT DEFAULT 'general',

    -- Status Management
    status TEXT NOT NULL DEFAULT 'initializing',
    locked_at TIMESTAMPTZ,
    locked_by TEXT,

    -- Progress Tracking
    total_tasks INTEGER DEFAULT 0,
    completed_tasks INTEGER DEFAULT 0,
    current_task_key TEXT,
    progress_percentage DECIMAL(5,2) DEFAULT 0.00,

    -- Results
    report_content TEXT,
    report_url TEXT,
    summary TEXT,
    key_findings JSONB,

    -- Notifications
    notify_email TEXT NOT NULL,
    notification_sent_at TIMESTAMPTZ,

    -- Execution Metadata
    execution_id TEXT,
    retries SMALLINT DEFAULT 0,
    max_retries SMALLINT DEFAULT 3,
    error_message TEXT,
    error_details JSONB,

    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    started_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,

    -- Constraints
    CONSTRAINT valid_status CHECK (status IN (
        'initializing', 'planning', 'planned', 'executing',
        'synthesizing', 'generating_report', 'complete', 'failed', 'cancelled'
    )),
    CONSTRAINT valid_research_type CHECK (research_type IN (
        'general', 'compliance', 'competitive', 'technical', 'financial'
    ))
);

-- Indexes
CREATE INDEX idx_research_jobs_user_id ON research_jobs(user_id);
CREATE INDEX idx_research_jobs_status ON research_jobs(status);
CREATE INDEX idx_research_jobs_created_at ON research_jobs(created_at DESC);
CREATE INDEX idx_research_jobs_user_status ON research_jobs(user_id, status);
```

### Status Values

| Status | Description |
|--------|-------------|
| `initializing` | Project created, awaiting task planning |
| `planning` | Claude analyzing query and creating tasks |
| `planned` | Task plan complete, ready for execution |
| `executing` | Tasks being processed |
| `synthesizing` | Retrieval complete, synthesis in progress |
| `generating_report` | Writing final report |
| `complete` | All tasks done, report ready |
| `failed` | Unrecoverable error occurred |
| `cancelled` | User cancelled the project |

---

## Table: plan_tasks

**Purpose**: Individual tasks within a research project

```sql
CREATE TABLE public.plan_tasks (
    -- Primary Key
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

    -- Relationships
    job_id BIGINT NOT NULL REFERENCES research_jobs(id) ON DELETE CASCADE,
    parent_task_id BIGINT REFERENCES plan_tasks(id) ON DELETE SET NULL,

    -- Task Identity
    task_key TEXT NOT NULL,
    sequence_order INTEGER NOT NULL,

    -- Task Definition
    task_type TEXT NOT NULL,
    task_title TEXT,
    task_description TEXT,
    query TEXT,
    config JSONB DEFAULT '{}',

    -- Dependencies
    depends_on TEXT[],

    -- Status Management
    status TEXT NOT NULL DEFAULT 'pending',

    -- Results
    result_summary TEXT,
    result_data JSONB,
    artifacts_count INTEGER DEFAULT 0,

    -- Execution Metadata
    started_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,
    duration_seconds INTEGER,
    retry_count SMALLINT DEFAULT 0,
    error_message TEXT,
    error_details JSONB,

    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT NOW(),

    -- Constraints
    UNIQUE(job_id, task_key),
    CONSTRAINT valid_task_status CHECK (status IN (
        'pending', 'queued', 'running', 'complete', 'failed', 'skipped', 'cancelled'
    )),
    CONSTRAINT valid_task_type CHECK (task_type IN (
        'retrieval_rag', 'retrieval_nlq', 'retrieval_graph', 'retrieval_api',
        'synthesis', 'fact_check', 'write_section', 'write_report', 'review'
    ))
);

-- Indexes
CREATE INDEX idx_plan_tasks_job_id ON plan_tasks(job_id);
CREATE INDEX idx_plan_tasks_status ON plan_tasks(status);
CREATE INDEX idx_plan_tasks_sequence ON plan_tasks(job_id, sequence_order);
CREATE INDEX idx_plan_tasks_type ON plan_tasks(task_type);
```

### Task Types

| Type | Description | Executor |
|------|-------------|----------|
| `retrieval_rag` | Vector similarity search | RetrievalExecutor |
| `retrieval_nlq` | Natural language query | RetrievalExecutor |
| `retrieval_graph` | Knowledge graph traversal | RetrievalExecutor |
| `retrieval_api` | External API call | RetrievalExecutor |
| `synthesis` | Combine findings | SynthesisExecutor |
| `fact_check` | Verify claims | SynthesisExecutor |
| `write_section` | Write report section | ReportExecutor |
| `write_report` | Generate full report | ReportExecutor |
| `review` | Quality assurance | ReportExecutor |

---

## Table: research_artifacts

**Purpose**: Stores outputs from task execution (retrieved content, findings, sections)

```sql
CREATE TABLE public.research_artifacts (
    -- Primary Key
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

    -- Relationships
    job_id BIGINT NOT NULL REFERENCES research_jobs(id) ON DELETE CASCADE,
    task_id BIGINT REFERENCES plan_tasks(id) ON DELETE SET NULL,

    -- Artifact Identity
    artifact_type TEXT NOT NULL,

    -- Source Information
    source TEXT,
    source_type TEXT,
    source_id TEXT,
    source_url TEXT,

    -- Content
    query_used TEXT,
    raw_response JSONB,
    processed_content TEXT,

    -- Quality Metrics
    relevance_score DECIMAL(5,4),
    confidence_score DECIMAL(5,4),
    citation_info JSONB,

    -- Metadata
    metadata JSONB DEFAULT '{}',

    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT NOW(),

    -- Constraints
    CONSTRAINT valid_artifact_type CHECK (artifact_type IN (
        'retrieved_chunk', 'query_result', 'graph_path', 'api_response',
        'synthesis_finding', 'fact_check_result', 'report_section', 'final_report'
    )),
    CONSTRAINT valid_source_type CHECK (source_type IS NULL OR source_type IN (
        'document', 'database', 'graph', 'api', 'ai_generated'
    ))
);

-- Indexes
CREATE INDEX idx_research_artifacts_job_id ON research_artifacts(job_id);
CREATE INDEX idx_research_artifacts_task_id ON research_artifacts(task_id);
CREATE INDEX idx_research_artifacts_type ON research_artifacts(artifact_type);
```

---

## Table: shared_reports

**Purpose**: Manages public shareable links for completed reports (FR-005, FR-005a)

```sql
CREATE TABLE public.shared_reports (
    -- Primary Key
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

    -- Relationships
    job_id BIGINT NOT NULL REFERENCES research_jobs(id) ON DELETE CASCADE,

    -- Share Token (public URL identifier)
    share_token TEXT NOT NULL UNIQUE,

    -- Access Control
    created_by UUID NOT NULL REFERENCES auth.users(id),
    revoked_at TIMESTAMPTZ,  -- NULL = active, timestamp = revoked
    revoked_by UUID REFERENCES auth.users(id),

    -- Usage Tracking
    view_count INTEGER DEFAULT 0,
    last_viewed_at TIMESTAMPTZ,

    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_shared_reports_job_id ON shared_reports(job_id);
CREATE INDEX idx_shared_reports_token ON shared_reports(share_token);
CREATE INDEX idx_shared_reports_active ON shared_reports(job_id) WHERE revoked_at IS NULL;
```

---

## Row-Level Security Policies

### research_jobs RLS

```sql
ALTER TABLE research_jobs ENABLE ROW LEVEL SECURITY;

-- Users can only see their own jobs
CREATE POLICY "Users can view own research jobs"
    ON research_jobs FOR SELECT
    USING (auth.uid() = user_id);

-- Users can create their own jobs
CREATE POLICY "Users can create own research jobs"
    ON research_jobs FOR INSERT
    WITH CHECK (auth.uid() = user_id);

-- Users can update their own jobs
CREATE POLICY "Users can update own research jobs"
    ON research_jobs FOR UPDATE
    USING (auth.uid() = user_id);

-- Users can delete their own jobs
CREATE POLICY "Users can delete own research jobs"
    ON research_jobs FOR DELETE
    USING (auth.uid() = user_id);
```

### plan_tasks RLS

```sql
ALTER TABLE plan_tasks ENABLE ROW LEVEL SECURITY;

-- Inherit access from parent job
CREATE POLICY "Users can view tasks for own jobs"
    ON plan_tasks FOR SELECT
    USING (EXISTS (
        SELECT 1 FROM research_jobs
        WHERE research_jobs.id = plan_tasks.job_id
        AND research_jobs.user_id = auth.uid()
    ));
```

### research_artifacts RLS

```sql
ALTER TABLE research_artifacts ENABLE ROW LEVEL SECURITY;

-- Inherit access from parent job
CREATE POLICY "Users can view artifacts for own jobs"
    ON research_artifacts FOR SELECT
    USING (EXISTS (
        SELECT 1 FROM research_jobs
        WHERE research_jobs.id = research_artifacts.job_id
        AND research_jobs.user_id = auth.uid()
    ));
```

### shared_reports RLS

```sql
ALTER TABLE shared_reports ENABLE ROW LEVEL SECURITY;

-- Users can manage shares for their own jobs
CREATE POLICY "Users can view own job shares"
    ON shared_reports FOR SELECT
    USING (EXISTS (
        SELECT 1 FROM research_jobs
        WHERE research_jobs.id = shared_reports.job_id
        AND research_jobs.user_id = auth.uid()
    ));

CREATE POLICY "Users can create shares for own jobs"
    ON shared_reports FOR INSERT
    WITH CHECK (EXISTS (
        SELECT 1 FROM research_jobs
        WHERE research_jobs.id = shared_reports.job_id
        AND research_jobs.user_id = auth.uid()
    ));

CREATE POLICY "Users can revoke own shares"
    ON shared_reports FOR UPDATE
    USING (created_by = auth.uid());
```

---

## Pydantic Models

See `app/models/research_project.py` in the architecture document for complete Pydantic model definitions including:

- `ResearchType` (enum)
- `JobStatus` (enum)
- `TaskType` (enum)
- `TaskStatus` (enum)
- `CreateResearchProjectRequest`
- `ResearchProjectResponse`
- `TaskResponse`
- `ProgressUpdate`

---

## Migration Order

```bash
migrations/
├── 001_create_research_jobs.sql      # Core jobs table
├── 002_create_plan_tasks.sql         # Tasks with dependencies
├── 003_create_research_artifacts.sql # Output artifacts
├── 004_create_shared_reports.sql     # Public link management
└── 005_enable_rls_policies.sql       # Security policies
```
